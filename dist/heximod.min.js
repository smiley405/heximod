"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function heximod(e){var t=new Hexi(e);return t.mod="0.1",t}var Hexi=function(){function e(t){var n=this;if(_classCallCheck(this,e),t.pixi=void 0!==t.pixi?t.pixi:PIXI,this.createModulePropertyAliases(t.pixi),this.app=new this.pixi.Application(t.settings),this.canvas=this.app.view,Object.defineProperties.bind(this,this.canvas,{halfWidth:{get:function(){return this.canvas.width/2},enumerable:!0,configurable:!0},halfHeight:{get:function(){return this.canvas.height/2},enumerable:!0,configurable:!0}}),this.canvas.scaled=!1,t.border&&(this.canvas.style.border=t.border),t.settings.viewContainer?t.settings.viewContainer.appendChild(this.canvas):document.body.appendChild(this.canvas),this.gameStage=new this.Container,this.app.stage.addChild(this.gameStage),this.addProperties(this.gameStage),this.gameStage._stage=!0,this.state=void 0,void 0!==t.load&&(this.loadState=t.load),!t.setup)throw new Error("Please supply the setup option in the constructor to tell Hexi which function should run first when it starts.");this.setupState=t.setup,this.loadingProgress=0,this.loadingFile="",void 0!==t.assets&&(this.assetsToLoad=t.assets),this._progressBarAdded=!1,this.soundObjects={},this.app.ticker.add(function(e){n.update(e)}),this.responseIframe()}return _createClass(e,[{key:"start",value:function(){this.assetsToLoad?(this.load(this.assetsToLoad,this.validateAssets),this.loadState&&(this.state=this.loadState)):this.setupState()}},{key:"load",value:function(e){var t,n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,a=(t=this.grabEntensions("font"),e.filter(function(e){var n=e.split(".").pop();if(-1!==t.indexOf(n))return!0}));a.length>0&&(this.spanElements=[],a.forEach(function(e){var t=e.split("/").pop().split(".")[0];n.fontFamilies&&n.fontFamilies.push(t);var i=document.createElement("style"),a="@font-face {font-family: '"+t+"'; src: url('"+e+"');}";i.appendChild(document.createTextNode(a)),document.head.appendChild(i);var r=document.createElement("span");r.style.fontFamily=t,document.body.appendChild(r),r.innerHTML="?",r.style.display="block",r.style.opacity="0",n.spanElements.push(r)})),this.grabEntensions("sound").forEach(function(e){n.loaderResource.setExtensionLoadType(e,n.loaderResource.LOAD_TYPE.XHR),n.loaderResource.setExtensionXhrType(e,n.loaderResource.XHR_RESPONSE_TYPE.BUFFER)});this.loader.reset(),this.loadingProgress=0,this.loadingFile="",this.loader.add(e).load(i.bind(this)),this.loader.onLoad.add(function(e,t){n.loadingFile=t.url,n.loadingProgress=e.progress,n.loadingBar()})}},{key:"uploadToGPU",value:function(){var e=this.pixi.utils.TextureCache;for(var t in e)this.app.renderer.plugins.prepare.upload(e[t])}},{key:"validateAssets",value:function(){var e=this;console.log("All assets loaded");var t=function(){e.assetsToLoad=[],e.loadState=void 0,e.state=void 0,e._progressBarAdded&&e.progressBar.remove(),e.spanElements&&e.spanElements.forEach(function(e){e.style.display="none"}),e.uploadToGPU(),e.setupState()};this.injectValidateAssets(t)||t()}},{key:"update",value:function(e){this.systemUpdate(e),this.state&&!this.paused&&this.state(e)}},{key:"systemUpdate",value:function(e){}},{key:"pause",value:function(){this.paused=!0}},{key:"resume",value:function(){this.paused=!1}},{key:"grabEntensions",value:function(e){switch(e){case"font":return["ttf","otf","ttc","woff"];case"sound":return["wav","mp3","ogg","webm"]}}},{key:"injectSystem",value:function(e){e&&e(this)}},{key:"injectValidateAssets",value:function(e){}},{key:"createModulePropertyAliases",value:function(e){this.pixi=e,this.Container=this.pixi.Container,this.loader=this.pixi.Loader?this.pixi.Loader.shared:this.pixi.loader,this.loaderResource=this.pixi.LoaderResource?this.pixi.LoaderResource:this.pixi.loaders.Resource,this.TextureCache=this.pixi.utils.TextureCache,this.filters=this.pixi.filters,this.injectSystem()}},{key:"flowRight",value:function(e){for(var t=function(t){if(t.length>0)for(var n=0;n<t.length-1;n++){t[n].putRight(t[n+1],+e)}},n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];i[0]instanceof Array?t(i[0]):t(i)}},{key:"flowDown",value:function(e){for(var t=function(t){if(t.length>0)for(var n=0;n<t.length-1;n++){t[n].putBottom(t[n+1],0,+e)}},n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];i[0]instanceof Array?t(i[0]):t(i)}},{key:"flowLeft",value:function(e){for(var t=function(t){if(t.length>0)for(var n=0;n<t.length-1;n++){t[n].putLeft(t[n+1],-e)}},n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];i[0]instanceof Array?t(i[0]):t(i)}},{key:"flowUp",value:function(e){for(var t=function(t){if(t.length>0)for(var n=0;n<t.length-1;n++){t[n].putTop(t[n+1],0,-e)}},n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];i[0]instanceof Array?t(i[0]):t(i)}},{key:"addProperties",value:function(){for(var e=this,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];n.forEach(function(t){t.vx=0,t.vy=0,t.accel={x:0,y:0},t.health=100,t.killed=!1,t._layer=0,t._circular=!1,t._interact=!1,t._draggable=!1,t._bumpPropertiesAdded=!0,t.swapChildren=function(e,n){var i=t.children.indexOf(e),a=t.children.indexOf(n);if(-1===i||-1===a)throw new Error(child+" Both objects must be a child of the caller "+t);e.childIndex=a,n.childIndex=i,t.children[i]=n,t.children[a]=e},t.add=function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];n.length>1?n.forEach(function(e){return t.addChild(e)}):t.addChild(n[0])},t.remove=function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];n.length>1?n.forEach(function(e){return t.removeChild(e)}):t.removeChild(n[0])};var n=t,i=function(e,t,n){return void 0!==e.anchor&&0!==e.anchor[n]?t*(1-e.anchor[n]-e.anchor[n]):t},a=function(e,t,n){return void 0!==e.anchor&&0!==e.anchor[n]?t*e.anchor[n]:0},r=function(e,t,n,i){return a(e,e[n],i)+a(t,t[n],i)};t.putCenter=function(a){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;t._stage&&(n=e.compensateForStageSize(t)),a.x=n.x+i(n,n.halfWidth,"x")-i(a,a.halfWidth,"x")+r,a.y=n.y+i(n,n.halfHeight,"y")-i(a,a.halfHeight,"y")+o,t._stage||t.compensateForParentPosition(n,a)},t.putLeft=function(a){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;t._stage&&(n=e.compensateForStageSize(t)),a.x=n.x-i(a,a.width,"x")+o-r(n,a,"width","x"),a.y=n.y+i(n,n.halfHeight,"y")-i(a,a.halfHeight,"y")+s,t._stage||t.compensateForParentPosition(n,a)},t.putTop=function(a){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;t._stage&&(n=e.compensateForStageSize(t)),a.x=n.x+i(n,n.halfWidth,"x")-i(a,a.halfWidth,"x")+o,a.y=n.y-i(a,a.height,"y")+s-r(n,a,"height","y"),t._stage||t.compensateForParentPosition(n,a)},t.putRight=function(a){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;t._stage&&(n=e.compensateForStageSize(t)),a.x=n.x+i(n,n.width,"x")+o+r(n,a,"width","x"),a.y=n.y+i(n,n.halfHeight,"y")-i(a,a.halfHeight,"y")+s,t._stage||t.compensateForParentPosition(n,a)},t.putBottom=function(a){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;t._stage&&(n=e.compensateForStageSize(t)),a.x=n.x+i(n,n.halfWidth,"x")-i(a,a.halfWidth,"x")+o,a.y=n.y+i(n,n.height,"y")+s+r(n,a,"height","y"),t._stage||t.compensateForParentPosition(n,a)},t.compensateForParentPosition=function(e,t){0===t.parent.gx&&0===t.parent.gy||(t.x-=e.gx,t.y-=e.gy)},Object.defineProperties(t,{gx:{get:function(){return t.getGlobalPosition().x},enumerable:!0,configurable:!0},gy:{get:function(){return t.getGlobalPosition().y},enumerable:!0,configurable:!0},centerX:{get:function(){return t.x+t.width/2-t.xAnchorOffset},enumerable:!0,configurable:!0},centerY:{get:function(){return t.y+t.height/2-t.yAnchorOffset},enumerable:!0,configurable:!0},halfWidth:{get:function(){return t.width/2},enumerable:!0,configurable:!0},halfHeight:{get:function(){return t.height/2},enumerable:!0,configurable:!0},scaleModeNearest:{set:function(e){if(!t.texture.baseTexture)throw new Error("The scale mode of ".concat(t," cannot be modified"));t.texture.baseTexture.scaleMode=e?this.pixi.SCALE_MODES.NEAREST:this.pixi.SCALE_MODES.LINEAR},enumerable:!0,configurable:!0},pivotX:{get:function(){return t.anchor.x},set:function(e){if(void 0===t.anchor)throw new Error("".concat(t," does not have a PivotX value"));t.anchor.x=e,t._previousPivotX?t.x+=(e-t._previousPivotX)*t.width:t.x+=e*t.width,t._previousPivotX=e},enumerable:!0,configurable:!0},pivotY:{get:function(){return t.anchor.y},set:function(e){if(void 0===t.anchor)throw new Error("".concat(t," does not have a PivotY value"));t.anchor.y=e,t._previousPivotY?t.y+=(e-t._previousPivotY)*t.height:t.y+=e*t.height,t._previousPivotY=e},enumerable:!0,configurable:!0},xAnchorOffset:{get:function(){return void 0!==t.anchor?t.height*t.anchor.x:0},enumerable:!0,configurable:!0},yAnchorOffset:{get:function(){return void 0!==t.anchor?t.width*t.anchor.y:0},enumerable:!0,configurable:!0},scaleX:{get:function(){return t.scale.x},set:function(e){t.scale.x=e},enumerable:!0,configurable:!0},scaleY:{get:function(){return t.scale.y},set:function(e){t.scale.y=e},enumerable:!0,configurable:!0},layer:{get:function(){return t._layer},set:function(e){t._layer=e,t.parent&&t.parent.children.sort(function(e,t){return e.layer-t.layer})},enumerable:!0,configurable:!0},localBounds:{get:function(){return{x:0,y:0,width:t.width,height:t.height}},enumerable:!0,configurable:!0},globalBounds:{get:function(){return{x:t.gx,y:t.gy,width:t.gx+t.width,height:t.gy+t.height}},enumerable:!0,configurable:!0},empty:{get:function(){return 0===t.children.length},enumerable:!0,configurable:!0},circular:{get:function(){return t._circular},set:function(e){!0===e&&!1===t._circular&&(Object.defineProperties(t,{diameter:{get:function(){return t.width},set:function(e){t.width=e,t.height=e},enumerable:!0,configurable:!0},radius:{get:function(){return t.halfWidth},set:function(e){t.width=2*e,t.height=2*e},enumerable:!0,configurable:!0}}),t._circular=!0),!1===e&&!0===t._circular&&(delete t.diameter,delete t.radius,t._circular=!1)},enumerable:!0,configurable:!0}}),t.setPosition=function(e,n){t.x=e,t.y=n},t.setScale=function(e,n){t.scale.x=e,t.scale.y=n},t.setPivot=function(e,n){t.pivotX=e,t.pivotY=n},t.circular&&Object.defineProperty(t,"radius",{get:function(){return t.width/2},enumerable:!0,configurable:!0})})}},{key:"log",value:function(e){return console.log(e)}},{key:"makeProgressBar",value:function(){var e=this,t={maxWidth:0,height:0,backgroundColor:"0x808080",foregroundColor:"0x00FFFF",container:null,backBar:null,frontBar:null,percentage:null,assets:null,initialized:!1,create:function(){t.maxWidth=e.canvas.width/2,t.container=new e.pixi.Container,t.backBar=new e.pixi.Graphics,t.backBar.beginFill(t.backgroundColor),t.backBar.drawRect(0,0,t.maxWidth,32),t.backBar.x=e.canvas.width/2-t.maxWidth/2,t.backBar.y=e.canvas.height/2-16,t.frontBar=new e.pixi.Graphics,t.frontBar.drawRect(0,0,t.maxWidth,32),t.frontBar.x=e.canvas.width/2-t.maxWidth/2,t.frontBar.y=e.canvas.height/2-16,t.percentage=new e.pixi.Text("0%",new e.pixi.TextStyle({fontFamily:"sans-serif",fontSize:28,fill:["black"]})),t.percentage.x=e.canvas.width/2-t.maxWidth/2+12,t.percentage.y=e.canvas.height/2-17,t.container.addChild(t.backBar,t.frontBar,t.percentage),e.gameStage.addChild(t.container)},update:function(){var n=e.loadingProgress/100;t.frontBar.width=t.maxWidth*n,t.percentage.text="".concat(Math.round(e.loadingProgress)," %")},remove:function(){e.gameStage.removeChild(t.container)}};return t}},{key:"loadingBar",value:function(){this._progressBarAdded?this.progressBar.update():(this.progressBar=this.makeProgressBar(),this.progressBar.create(),this._progressBarAdded=!0)}},{key:"compensateForStageSize",value:function(e){if(!0===e._stage){var t={x:0,y:0};return t.width=this.canvas.width,t.height=this.canvas.height,t.halfWidth=this.canvas.width/2,t.halfHeight=this.canvas.height/2,t.xAnchorOffset=0,t.yAnchorOffset=0,t}}},{key:"image",value:function(e){if(this.TextureCache[e])return this.TextureCache[e];throw new Error("".concat(e," does not appear to be an image"))}},{key:"id",value:function(e){if(this.TextureCache[e])return this.TextureCache[e];throw new Error("".concat(e," does not appear to be a texture atlas frame id"))}},{key:"json",value:function(e){if(this.loader.resources[e].data)return this.resources[e].data;throw new Error("".concat(e," does not appear to be a JSON data file"))}},{key:"xml",value:function(e){if(this.loader.resources[e].data)return this.resources[e].data;throw new Error("".concat(e," does not appear to be a XML data file"))}},{key:"sound",value:function(e){if(this.soundObjects[e])return this.soundObjects[e];throw new Error("".concat(e," does not appear to be a sound object"))}},{key:"responseIframe",value:function(){window.addEventListener("load",function(){window.focus(),document.body.addEventListener("click",function(e){window.focus()},!1)})}},{key:"resources",get:function(){return this.app.loader.resources}},{key:"border",set:function(e){this.canvas.style.border=e}}]),e}();